#!/bin/ksh

set -eu

usage() {
	echo "usage: robsd-clean count" 1>&2
	exit 1
}

# getmode path
getmode() {
	case "${1##*/}" in
	robsd-ports-clean)	echo "robsd-ports";;
	robsd-regress-clean)	echo "robsd-regress";;
	*)			echo "robsd";;
	esac
}

# config_path
config_path() {
	case "$_MODE" in
	robsd)
		echo "${ROBSDCONF:-/etc/robsd.conf}"
		;;
	robsd-ports)
		echo "${ROBSDCONF:-/etc/robsd-ports.conf}"
		;;
	robsd-regress)
		echo "${ROBSDCONF:-/etc/robsd-regress.conf}"
		;;
	*)
		return 1
		;;
	esac
}

. "${EXECDIR:-/usr/local/libexec/robsd}/util.sh"

[ $# -ne 1 ] && usage

setmode "$(getmode "$0")"
setprogname "$(getmode "$0")-clean"
[ "$(id -u)" -ne 0 ] && fatal "must be run as root"
config_load "$(config_path)"

purge "$ROBSDDIR" "$1" | while read -r _d; do
	info "moving ${_d} to the attic"
done
