.Dd $Mdocdate: November 27 2018$
.Dt ROBSD 8
.Os
.Sh NAME
.Nm robsd
.Nd build OpenBSD release
.Sh SYNOPSIS
.Nm robsd
.Op Fl v
.Op Fl c Ar file
.Op Fl S Ar src-diff
.Op Fl X Ar xenocara-diff
.Nm
.Op Fl v
.Fl r Ar path
.Sh DESCRIPTION
The
.Nm
utility builds a
.Ox
release according to the
.Xr release 8
process.
Some steps are enhanced as follows:
.Bl -dash
.It
During step 2
.Pq Build and install a new kernel
the
.Pa GENERIC.MP
kernel is favored on multiprocessor machines based on
.Va hw.ncpu ,
see
.Xr sysctl 8 .
Otherwise,
the
.Pa GENERIC
kernel is used.
.El
.Pp
In addition, the following steps are also executed:
.Bl -dash
.It
After step 2
.Pq Build and install a new kernel
the machine is rebooted.
Upon the next boot, the same release build is resumed from
.Xr rc.firsttime 8 .
.It
After step 8
.Pq Create boot and installation disk images
the final release files are distributed to another host using
.Xr scp 1 .
.El
.Pp
Each release build is identified by a directory created by
.Nm
rooted in
.Ev BUILDDIR
and named after the current date.
The release directory contains the entries as follows.
In addition, each executed step has a corresponding log file in the same
directory.
.Bl -tag -width Ds
.It Pa comment
File used to annotate the release build.
.It Pa reldir
Directory containing the final release files.
Referred to as RELEASEDIR in
.Xr release 8 .
.It Pa report
A summary of the release build which is delivered as a mail to root once
.Nm
exits.
.It Pa steps
Internal representation of the executed steps.
This file should never be edited manually.
.El
.Pp
.Nm
must be run as root.
Some steps can however operate on behalf of another user using
.Xr su 1 ,
see
.Sx ENVIRONMENT .
.Pp
The options are as follows:
.Bl -tag -width Ds
.It Fl c Ar file
Annotate the release build.
.Ar file
is copied to
.Pa comment
in the release directory.
If
.Ar file
is
.Sq - ,
stdin is used.
.It Fl r Ar path
Resume a release build located at
.Ar path .
If the last executed step failed, it will be executed again.
Otherwise, the next step will be executed.
.It Fl S Ar src-diff
Diff to apply to the src tree.
The same diff will be reverted once the release is finished.
In addition, a copy of the diff is saved to a file named
.Pa src.diff
in the release directory.
.It Fl v
Enable verbose output.
.It Fl X Ar xenocara-diff
Diff to apply to the xenocara tree.
The same diff will be reverted once the release is finished.
In addition, a copy of the diff is saved to a file named
.Pa xenocara.diff
in the release directory.
.El
.Sh ENVIRONMENT
The
.Nm
utility is configured using environment variables.
Variables and can optionally be specified in
.Pa /etc/robsdrc ,
which is sourced during runtime.
Where the latter takes higher precedence.
.Pp
The following variables are recognized.
Default values are displayed in brackets.
.Bl -tag -width Ds
.It Ev BSDOBJDIR
Object directory for the src tree.
.Bq Pa /usr/obj
.It Ev BSDSRCDIR
Source directory for the src tree.
.Bq Pa /usr/src
.It Ev BUILDDIR
Directory to store releases.
.It Ev CVSROOT
Upstream
.Xr cvs 1
repository used to update sources from.
.It Ev CVSUSER
User to perform
.Xr cvs 1
and
.Xr patch 1
operations on behalf of.
.It Ev DESTDIR
Directory rooted on a filesystem mounted with the
.Em noperm
.Xr mount 8
option, see
.Xr release 8 .
.It Ev DISTRIBHOST
Host to upload the final release files to during the distribution step.
.It Ev DISTRIBPATH
Directory on
.Ev DISTRIBHOST
to upload the final release files to during the distribution step.
.It Ev DISTRIBUSER
User to perform
.Xr scp 1
operations on behalf of.
.It Ev KEEP
Number of releases to keep in
.Ev BUILDDIR ,
see
.Xr robsd-clean 8 .
Defaults to keeping all releases.
.Bq 0
.It Ev MAKEFLAGS
Options passed to
.Xr make 1 .
Defaults to setting the maximum number of processes option to the value of
.Va hw.ncpuonline ,
see
.Xr sysctl 8 .
.It Ev SIGNIFY
Private key used to optionally sign the final release files using
.Xr signify 1 .
.It Ev SRCDIFF
Path to sticky diff to always apply to the src tree.
The diff is ignored if the path does not exist.
Otherwise, it cannot be combined with option
.Fl S .
.It Ev XDIFF
Path to sticky diff to always apply to the xenocara tree.
The diff is ignored if the path does not exist.
Otherwise, it cannot be combined with option
.Fl X .
.It Ev XOBJDIR
Object directory for the xenocara tree.
.Bq /usr/xobj
.It Ev XSRCDIR
Source directory for the xenocara tree.
.Bq /usr/xenocara
.El
.Sh FILES
.Bl -tag -width Ds
.It Pa /etc/robsdrc
The default configuration file.
.El
.Sh EXAMPLES
Example
.Pa /etc/robsdrc
configuration file with all mandatory variables present:
.Bd -literal
BUILDDIR=/home/snapshots
CVSROOT=anoncvs@anoncvs.eu.openbsd.org:/cvs
CVSUSER=anton
DESTDIR=/home/noperm
DISTRIBHOST=example.com
DISTRIBPATH=/var/www/pub/OpenBSD/snapshots/`machine`
DISTRIBUSER=anton
.Ed
.Sh DIAGNOSTICS
.Ex -std
.Sh SEE ALSO
.Xr release 8 ,
.Xr robsd-clean 8
.Sh AUTHORS
.An Anton Lindqvist Aq Mt anton@basename.se
