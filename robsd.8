.Dd $Mdocdate: November 27 2018$
.Dt ROBSD 8
.Os
.Sh NAME
.Nm robsd
.Nd build OpenBSD release
.Sh SYNOPSIS
.Nm robsd
.Op Fl D
.Op Fl s Ar step
.Op Fl S Ar src-diff
.Op Fl X Ar xenocara-diff
.Nm
.Op Fl D
.Fl r Ar path
.Sh DESCRIPTION
The
.Nm
utility builds a
.Ox
release according to the
.Xr release 8
process.
The process is divided into the steps as follows:
.Bl -tag -width checkflist
.It env
Dump the current environment.
This is a no operation only used to collect data useful while debugging.
.It cvs
Update the
.Ev BSDSRCDIR
and
.Ev XSRCDIR
source directories using the configured upstream, see
.Xr robsd.conf 5 .
.It patch
Apply any given src or xenocara diff to the corresponding source directory.
Any configured sticky diff is also applied, see
.Xr robsd.conf 5 .
.It kernel
Build and install a new kernel.
The
.Pa GENERIC.MP
kernel configuration is favored on multiprocessor machines based on
.Va hw.ncpu ,
see
.Xr sysctl 8 .
Otherwise,
the
.Pa GENERIC
kernel configuration is used.
.It reboot
Reboot the machine before continuing the build, exercising the new kernel.
The release build is resumed from
.Xr rc.firsttime 8 .
.It base
Build and install the base system.
Afterwards, update the machine using
.Xr sysmerge 8
and
.Xr MAKEDEV 8 .
.It release
Make and validate the base system.
.It checkflist
Check for missing contents in the release tarballs.
.It xbase
Build and install the xenocara system.
.It xrelease
Make and validate the xenocara system.
.It image
Create boot and installation disk images.
.It hash
Move system and xenocara release files into the
.Pa rel
directory associated with the current release build and compute checksums.
.It revert
Revert any applied src or xenocara diff, see the patch step above.
.It distrib
Distribute the release files located in the
.Pa rel
directory to another using
.Xr scp 1 .
This step is optional and requires presence of certain configuration, see
.Xr robsd.conf 5 .
.It end
Auxillary step used to generate
.Pa report .
.El
.Pp
Each invocation is identified by a directory created by
.Nm
rooted in
.Ev ROBSDDIR
and is named after the current date.
The directory contains the entries as follows.
In addition, each executed step has a corresponding log file in the same
directory.
.Bl -tag -width robsd.log
.It Pa comment
File used to annotate the release build which is include in
.Pa report .
By default, it contains a list of all applied patches.
.It Pa rel
Directory containing the final release files.
Referred to as RELEASEDIR in
.Xr release 8 .
.It Pa report
A summary delivered as a mail to root while running in detached mode once
.Nm
exits.
.It Pa robsd.log
Standard output and error from
.Nm
while running in detached mode.
.It Pa steps
Internal representation of the executed steps.
This file should never be edited manually.
.El
.Pp
.Nm
is configured using
.Xr robsd.conf 5
and must be run as root.
Some steps can however operate on behalf of another user, see
.Xr robsd.conf 5 .
.Pp
The options are as follows:
.Bl -tag -width Ds
.It Fl D
Detach
.Nm
into the background.
.It Fl r Ar path
Resume a release build located at
.Ar path .
If the last executed step failed or aborted, it will be executed again.
Otherwise, the next step will be executed.
.It Fl s Ar step
Skip
.Ar step ,
see enumerated steps above.
May be given multiple times.
.It Fl S Ar src-diff
Diff to apply to the src tree.
The diff path names can be relative to any directory in the src tree.
The same diff will be reverted once the release is finished.
In addition, a copy of the diff is saved to a file named
.Pa src.diff.N
in the release directory where N is incremented for every given diff.
May be given multiple times.
.It Fl X Ar xenocara-diff
Diff to apply to the xenocara tree.
The diff path names can be relative to any directory in the xenocara tree.
The same diff will be reverted once the release is finished.
In addition, a copy of the diff is saved to a file named
.Pa xenocara.diff.N
in the release directory where N is incremented for every given diff.
May be given multiple times.
.El
.Sh FILES
.Bl -tag -width Ds
.It Pa /etc/robsd.conf
The default configuration file.
.El
.Sh DIAGNOSTICS
.Ex -std
.Sh SEE ALSO
.Xr robsd.conf 5 ,
.Xr release 8 ,
.Xr robsd-clean 8 ,
.Xr robsd-ports 8 ,
.Xr robsd-regress 8 ,
.Xr robsd-rescue 8
.Sh AUTHORS
.An Anton Lindqvist Aq Mt anton@basename.se
